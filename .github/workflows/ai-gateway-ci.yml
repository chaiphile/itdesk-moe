name: ai-gateway CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  docker-tests:
    strategy:
      matrix:
        os: [ubuntu-latest, ubuntu-22.04]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Show environment
        run: |
          uname -a || true
          docker --version

      - name: Create .env for docker-compose
        run: |
          cat > .env <<EOF
          POSTGRES_USER=${POSTGRES_USER}
          POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
          POSTGRES_DB=${POSTGRES_DB}
          POSTGRES_PORT=${POSTGRES_PORT}
          DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:${POSTGRES_PORT}/${POSTGRES_DB}
          MINIO_ROOT_USER=${MINIO_ROOT_USER}
          MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
          MINIO_BUCKET=${MINIO_BUCKET}
          EOF
        env:
          POSTGRES_USER: ${{ secrets.POSTGRES_USER || 'postgres' }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD || 'change_me' }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB || 'ticketing_db' }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT || '5432' }}
          MINIO_ROOT_USER: ${{ secrets.MINIO_ROOT_USER || 'minio' }}
          MINIO_ROOT_PASSWORD: ${{ secrets.MINIO_ROOT_PASSWORD || 'change_me' }}
          MINIO_BUCKET: ticketing-attachments

      - name: Build ai-gateway image
        run: |
          docker compose build ai-gateway

      - name: Start Postgres for migrations
        run: |
          docker compose up -d postgres

      - name: Wait for Postgres to accept connections
        run: |
          echo "Waiting for Postgres to accept connections..."
          for i in $(seq 1 60); do
            docker compose run --rm postgres sh -c "pg_isready -h postgres -p ${POSTGRES_PORT} -U ${POSTGRES_USER}" && break
            echo "Postgres not ready yet ($i)..."
            sleep 1
          done
        env:
          POSTGRES_USER: ${{ secrets.POSTGRES_USER || 'postgres' }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT || '5432' }}

      - name: Validate migrations apply cleanly
        run: |
          set -e
          # Apply migrations (uses AI_GATEWAY_DB from compose environment)
          docker compose run --rm -w /app ai-gateway sh -c "alembic -c ai_gateway/alembic.ini upgrade head"
          # Show current
          docker compose run --rm -w /app ai-gateway sh -c "alembic -c ai_gateway/alembic.ini current"
          # Ensure exactly one head
          COUNT=$(docker compose run --rm -w /app ai-gateway sh -c "alembic -c ai_gateway/alembic.ini heads | wc -l")
          echo "heads count: $COUNT"
          if [ "$COUNT" -ne 1 ]; then
            echo "ERROR: expected exactly 1 head"; exit 2
          fi

      - name: Run tests inside ai-gateway container
        run: |
          docker compose run --rm -w /app ai-gateway python -m pytest ai_gateway/tests -q
